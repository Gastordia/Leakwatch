<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://xposedornot.com https://api.xposedornot.com;">
    <title>Morocco Breach Watch - Data Breach Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .breaches-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .breaches-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .breaches-title {
            font-size: 1.5rem;
            color: #333;
        }

        .last-updated {
            font-size: 0.9rem;
            color: #666;
        }

        .breach-item {
            background: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .breach-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .breach-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .breach-date {
            font-weight: bold;
            color: #667eea;
            font-size: 0.9rem;
        }

        .breach-source {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .breach-content {
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .breach-type {
            display: inline-block;
            background: #ffebee;
            color: #c62828;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .no-breaches {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .morocco-highlight {
            background: #fff3e0;
            color: #e65100;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .breach-author {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }

        .breach-source-url {
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .breach-source-url a {
            color: #667eea;
            text-decoration: none;
        }

        .breach-source-url a:hover {
            text-decoration: underline;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .reset-button {
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-button:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .filter-info {
            margin-bottom: 20px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            border-left: 4px solid #667eea;
        }

        /* Email Checker Styles */
        .email-checker {
            padding: 20px 0;
        }

        .checker-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .email-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
        }

        .email-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .check-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .check-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .check-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .email-results {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .results-header h3 {
            margin: 0;
            color: #333;
        }

        .risk-score {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .risk-score.safe {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .risk-score.medium {
            background: #fff3e0;
            color: #f57c00;
        }

        .risk-score.high {
            background: #ffebee;
            color: #c62828;
        }

        .breach-item-email {
            background: #f8f9fa;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .breach-item-email h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .breach-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
            flex-wrap: wrap;
        }

        .breach-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .breach-description {
            color: #555;
            line-height: 1.5;
            font-size: 14px;
        }

        .breach-data-types {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .data-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: #667eea;
            color: #667eea;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .breach-count {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .analytics-card h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .analytics-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .analytics-stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            font-weight: 600;
            color: #333;
        }

        .breach-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px;
        }

        .breach-list-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .breach-list-item:hover {
            background-color: #f8f9fa;
        }

        .breach-list-item:last-child {
            border-bottom: none;
        }

        .breach-list-item h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 14px;
        }

        .breach-list-item p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }

        /* Password Checker Styles */
        .password-result {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 15px;
        }

        .password-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .password-recommendation {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .password-recommendation h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .password-recommendation p {
            color: #856404;
            margin: 0;
        }

        /* Rate Limit Warning */
        .rate-limit-warning {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .warning-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .warning-content h4 {
            color: #856404;
            margin: 0 0 5px 0;
            font-size: 16px;
        }

        .warning-content p {
            color: #856404;
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Security Recommendations Styles */
        .security-recommendations {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 10px;
        }

        .security-recommendations ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }

        .security-recommendations li {
            margin-bottom: 8px;
            color: #333;
            line-height: 1.4;
        }

        .security-recommendations p {
            margin: 0 0 10px 0;
            color: #2e7d32;
            font-weight: 500;
        }

        /* Search and Filter Styles */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Main Tab Navigation Styles */
        .main-tab-navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .main-tab-button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            background: #f0f0f0;
            color: #666;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .main-tab-button:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .main-tab-button.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        /* Tools Information */
        .tools-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .tools-info h4 {
            color: #1976d2;
            margin: 0 0 10px 0;
            font-size: 16px;
        }

        .tools-info ul {
            margin: 0;
            padding-left: 20px;
        }

        .tools-info li {
            color: #1976d2;
            margin-bottom: 5px;
            font-size: 14px;
            line-height: 1.4;
        }

        .tools-info li:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .breaches-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .breach-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Morocco Breach Watch</h1>
            <p>Comprehensive data breach monitoring for Morocco</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalBreaches">-</div>
                <div class="stat-label">Total Breaches</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="moroccoBreaches">-</div>
                <div class="stat-label">Morocco Related</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lastUpdate">-</div>
                <div class="stat-label">Last Updated</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recentBreaches">-</div>
                <div class="stat-label">Last 7 Days</div>
            </div>
        </div>

        <!-- Main Navigation Tabs -->
        <div class="main-tab-navigation">
            <button class="main-tab-button active" onclick="switchMainTab('breaches')">üìã Latest Breaches</button>
            <button class="main-tab-button" onclick="switchMainTab('tools')">üîç Breach Lookup Tools</button>
        </div>

        <!-- Latest Breaches Tab -->
        <div id="breachesTab" class="main-tab-content active">
            <div class="breaches-container">
                <div class="breaches-header">
                    <h2 class="breaches-title">Latest Breaches</h2>
                    <div class="last-updated" id="lastUpdated">Loading...</div>
                </div>
                
                <!-- Search and Filter -->
                <div class="search-filter">
                    <input type="text" id="breachSearch" placeholder="Search breaches..." class="search-input">
                    <select id="breachFilter" class="filter-select">
                        <option value="all">All Breaches</option>
                        <option value="morocco">Morocco Related</option>
                        <option value="recent">Recent (Last 7 days)</option>
                    </select>
                    <button onclick="resetFilters()" class="reset-button">Reset</button>
                </div>
                
                <!-- Filter Info -->
                <div class="filter-info">
                    <span id="filterInfo">Loading...</span>
                </div>
                
                <div id="breachesList">
                    <div class="loading">Loading breach data...</div>
                </div>
            </div>
        </div>

        <!-- Breach Lookup Tools Tab -->
        <div id="toolsTab" class="main-tab-content">
            <div class="breaches-container">
                <div class="breaches-header">
                    <h2 class="breaches-title">üîç Breach Lookup Tools</h2>
                    <div class="last-updated">Professional breach lookup services</div>
                </div>
                
                <!-- API Rate Limit Warning -->
                <div class="rate-limit-warning">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-content">
                        <h4>Service Rate Limits</h4>
                        <p>Our breach lookup services have rate limits to ensure fair usage. If you encounter rate limit errors, please wait a few minutes before trying again.</p>
                    </div>
                </div>
                
                <!-- Tools Information -->
                <div class="tools-info">
                    <h4>Available Tools:</h4>
                    <ul>
                        <li><strong>Email Check:</strong> Comprehensive email security analysis and breach history</li>
                        <li><strong>Domain Search:</strong> Search for breaches related to specific domains</li>
                        <li><strong>All Breaches:</strong> Browse all known data breaches in the database</li>
                        <li><strong>Password Check:</strong> Check if a password has been exposed (anonymously)</li>
                    </ul>
                </div>
                
                <!-- Sub Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-button active" onclick="switchSubTab('analytics')">üìß Email Check</button>
                    <button class="tab-button" onclick="switchSubTab('domain')">üåê Domain Search</button>
                    <button class="tab-button" onclick="switchSubTab('all')">üìã All Breaches</button>
                    <button class="tab-button" onclick="switchSubTab('password')">üîë Password Check</button>
                </div>
                
                <!-- Email Check Tab -->
                <div id="analyticsTab" class="tab-content active">
                    <div class="checker-form">
                        <input type="email" id="analyticsEmailInput" placeholder="Enter email address to check..." class="email-input">
                        <button onclick="getBreachAnalytics()" class="check-button">Check Email</button>
                    </div>
                    
                    <div id="analyticsResults" class="email-results" style="display: none;">
                        <div class="results-header">
                            <h3 id="analyticsResultsTitle">Email Security Check</h3>
                        </div>
                        <div id="analyticsDetails"></div>
                    </div>
                    
                    <div id="analyticsLoading" class="loading" style="display: none;">
                        Checking email security...
                    </div>
                    
                    <div id="analyticsError" class="error" style="display: none;"></div>
                </div>
                
                <!-- Domain Search Tab -->
                <div id="domainTab" class="tab-content">
                    <div class="checker-form">
                        <input type="text" id="domainInput" placeholder="Enter domain (e.g., example.com)" class="email-input">
                        <button onclick="searchDomainBreaches()" class="check-button">Search Domain</button>
                    </div>
                    
                    <div id="domainResults" class="email-results" style="display: none;">
                        <div class="results-header">
                            <h3 id="domainResultsTitle">Domain Breach Results</h3>
                            <div class="risk-score" id="domainRiskScore"></div>
                        </div>
                        <div id="domainBreachDetails"></div>
                    </div>
                    
                    <div id="domainLoading" class="loading" style="display: none;">
                        Searching domain breaches...
                    </div>
                    
                    <div id="domainError" class="error" style="display: none;"></div>
                </div>
                

                
                <!-- All Breaches Tab -->
                <div id="allTab" class="tab-content">
                    <div class="checker-form">
                        <button onclick="getAllBreaches()" class="check-button">Load All Breaches</button>
                    </div>
                    
                    <div id="allBreachesResults" class="email-results" style="display: none;">
                        <div class="results-header">
                            <h3 id="allBreachesTitle">All Known Breaches</h3>
                            <div class="breach-count" id="totalBreachCount"></div>
                        </div>
                        <div id="allBreachesDetails"></div>
                    </div>
                    
                    <div id="allBreachesLoading" class="loading" style="display: none;">
                        Loading all breaches...
                    </div>
                    
                    <div id="allBreachesError" class="error" style="display: none;"></div>
                </div>

                <!-- Password Checker Tab -->
                <div id="passwordTab" class="tab-content">
                    <div class="checker-form">
                        <input type="password" id="passwordInput" placeholder="Enter password to check..." class="email-input">
                        <button onclick="checkPassword()" class="check-button">Check Password</button>
                    </div>
                    
                    <div id="passwordResults" class="email-results" style="display: none;">
                        <div class="results-header">
                            <h3 id="passwordResultsTitle">Password Security Check</h3>
                            <div class="risk-score" id="passwordRiskScore"></div>
                        </div>
                        <div id="passwordDetails"></div>
                    </div>
                    
                    <div id="passwordLoading" class="loading" style="display: none;">
                        Checking password...
                    </div>
                    
                    <div id="passwordError" class="error" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SHA3 Library for password hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.8.0/sha3.js"></script>
    <script>
        // Fallback if SHA3 library fails to load
        window.addEventListener('load', function() {
            if (typeof keccak_512 === 'undefined') {
                console.warn('SHA3 library failed to load, password checking will be disabled');
                // Disable password checking tab
                const passwordTab = document.querySelector('.tab-button[onclick*="password"]');
                if (passwordTab) {
                    passwordTab.style.opacity = '0.5';
                    passwordTab.title = 'Password checking unavailable - SHA3 library not loaded';
                }
            }
        });
    </script>
    
    <script>
        // Morocco-related keywords for filtering (restrictive)
        const moroccoKeywords = [
            'morocco', 'moroccan', 'maroc', '.ma', 'maghreb', 'maghrib'
        ];

        // Load and display breach data
        async function loadBreachData() {
            try {
                console.log('Loading breach data...');
                
                // Fetch data from our monitoring system
                const response = await fetch('https://raw.githubusercontent.com/Gastordia/Leakwatch/main/data.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const rawData = await response.json();
                console.log('Data loaded:', rawData.length, 'breaches');
                
                // Process and clean the data
                const data = processBreachData(rawData);
                console.log('Processed data:', data.length, 'breaches');
                
                // Store data globally for search/filter
                window.allBreachesData = data;
                
                // Set up filter listeners
                setupFilterListeners();
                
                displayBreaches(data);
                updateStats(data);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load breach data. Please try again later.');
            }
        }

        // Process and clean breach data from GitHub
        function processBreachData(rawData) {
            const seen = new Set();

            return rawData.map(item => {
                let processed = {
                    date: new Date().toISOString(),
                    source: 'Monitoring System',
                    type: 'Data Breach',
                    text: '',
                    content: '',
                    author: '',
                    detection_date: '',
                    source_url: ''
                };

                // Only process properly formatted JSON objects
                if (typeof item === 'object' && item.Content && item.Source && item.Type) {
                    // Valid JSON object format
                    processed.content = item.Content || '';
                    processed.author = item.author || '';
                    processed.detection_date = item['Detection Date'] || '';
                    processed.source_url = item.Source || '';
                    processed.type = item.Type || 'Data Breach';
                    
                    // Use Detection Date as the main date if available
                    if (item['Detection Date']) {
                        try {
                            const detectionDate = new Date(item['Detection Date']);
                            if (!isNaN(detectionDate.getTime())) {
                                processed.date = detectionDate.toISOString();
                            }
                        } catch (e) {
                            // Keep original date if parsing fails
                        }
                    }
                    
                    processed.text = processed.content; // For backward compatibility
                } else {
                    // Skip malformed entries
                    return null;
                }

                // Clean up HTML tags from author field
                if (processed.author) {
                    processed.author = processed.author.replace(/<[^>]*>/g, '');
                }

                // Create a unique identifier for deduplication
                const identifier = `${processed.content}_${processed.author}`;
                
                // Only add if we haven't seen this exact content before
                if (!seen.has(identifier) && processed.content.trim()) {
                    seen.add(identifier);
                    return processed;
                }
                
                return null; // Skip duplicates
            }).filter(item => item !== null); // Remove null items (duplicates)
        }

        // Display breaches in the UI with filtering
        function displayBreaches(breaches) {
            const container = document.getElementById('breachesList');
            const searchInput = document.getElementById('breachSearch');
            const filterSelect = document.getElementById('breachFilter');
            
            if (!breaches || breaches.length === 0) {
                container.innerHTML = '<div class="no-breaches">No breaches found</div>';
                return;
            }

            // Get current filter and search values
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const filterType = filterSelect ? filterSelect.value : 'all';

            // Apply filters
            let filteredBreaches = breaches;

            // Apply search filter
            if (searchTerm) {
                filteredBreaches = filteredBreaches.filter(breach => {
                    const content = (breach.text || breach.content || '').toLowerCase();
                    const author = (breach.author || '').toLowerCase();
                    const source = (breach.source || '').toLowerCase();
                    return content.includes(searchTerm) || author.includes(searchTerm) || source.includes(searchTerm);
                });
            }

            // Apply type filter
            switch (filterType) {
                case 'morocco':
                    filteredBreaches = filteredBreaches.filter(breach => {
                        const content = (breach.text || breach.content || '').toLowerCase();
                        return moroccoKeywords.some(keyword => {
                            const regex = new RegExp(`\\b${keyword.toLowerCase()}\\b`);
                            return regex.test(content);
                        });
                    });
                    break;
                case 'recent':
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    filteredBreaches = filteredBreaches.filter(breach => {
                        return new Date(breach.date) >= sevenDaysAgo;
                    });
                    break;
                case 'all':
                default:
                    // No additional filtering
                    break;
            }

            // Sort by date (newest first)
            filteredBreaches.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Update filter info
            updateFilterInfo(filteredBreaches.length, breaches.length, filterType, searchTerm);

            // Display results
            if (filteredBreaches.length === 0) {
                let message = 'No breaches found';
                if (searchTerm) {
                    message = `No breaches found matching "${searchTerm}"`;
                } else if (filterType === 'morocco') {
                    message = 'No Morocco-related breaches found';
                } else if (filterType === 'recent') {
                    message = 'No recent breaches found (last 7 days)';
                }
                
                container.innerHTML = `
                    <div class="no-breaches">
                        <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 10px; color: #856404;">
                            <strong>${message}</strong>
                        </div>
                        <button onclick="resetFilters()" class="reset-button">Reset Filters</button>
                    </div>
                `;
                return;
            }

            const breachesHTML = filteredBreaches.map(breach => {
                const content = breach.text || breach.content || '';
                const highlightedContent = filterType === 'morocco' ? highlightMoroccoKeywords(content) : content;
                const author = breach.author ? `<div class="breach-author">Author: ${breach.author}</div>` : '';
                const sourceUrl = breach.source_url ? `<div class="breach-source-url">Source: <a href="${breach.source_url}" target="_blank">${breach.source_url}</a></div>` : '';
                
                return `
                    <div class="breach-item">
                        <div class="breach-header">
                            <div class="breach-date">${formatDate(breach.date)}</div>
                            <div class="breach-source">${breach.source || 'Monitoring System'}</div>
                        </div>
                        <div class="breach-content">${highlightedContent}</div>
                        ${author}
                        ${sourceUrl}
                        <div class="breach-type">${breach.type || 'Data Breach'}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = breachesHTML;
        }

        // Highlight Morocco keywords in content (whole word matching)
        function highlightMoroccoKeywords(content) {
            let highlighted = content;
            moroccoKeywords.forEach(keyword => {
                const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
                highlighted = highlighted.replace(regex, '<span class="morocco-highlight">$1</span>');
            });
            return highlighted;
        }

        // Update filter information display
        function updateFilterInfo(filteredCount, totalCount, filterType, searchTerm) {
            const filterInfo = document.getElementById('filterInfo');
            if (!filterInfo) return;

            let info = `Showing ${filteredCount} of ${totalCount} breaches`;
            
            if (searchTerm) {
                info += ` matching "${searchTerm}"`;
            }
            
            if (filterType === 'morocco') {
                info += ' (Morocco-related only)';
            } else if (filterType === 'recent') {
                info += ' (Last 7 days only)';
            }
            
            filterInfo.textContent = info;
        }

        // Reset all filters
        function resetFilters() {
            const searchInput = document.getElementById('breachSearch');
            const filterSelect = document.getElementById('breachFilter');
            
            if (searchInput) searchInput.value = '';
            if (filterSelect) filterSelect.value = 'all';
            
            // Re-display with reset filters
            if (window.allBreachesData) {
                displayBreaches(window.allBreachesData);
            }
        }

        // Add event listeners for real-time filtering
        function setupFilterListeners() {
            const searchInput = document.getElementById('breachSearch');
            const filterSelect = document.getElementById('breachFilter');
            
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    if (window.allBreachesData) {
                        displayBreaches(window.allBreachesData);
                    }
                });
            }
            
            if (filterSelect) {
                filterSelect.addEventListener('change', () => {
                    if (window.allBreachesData) {
                        displayBreaches(window.allBreachesData);
                    }
                });
            }
        }

        // Update statistics
        function updateStats(breaches) {
            const moroccoBreaches = breaches.filter(breach => {
                const content = (breach.text || breach.content || '').toLowerCase();
                return moroccoKeywords.some(keyword => {
                    // Use word boundary regex for whole word matching
                    const regex = new RegExp(`\\b${keyword.toLowerCase()}\\b`);
                    return regex.test(content);
                });
            });

            // Count recent breaches (last 7 days)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentBreaches = breaches.filter(breach => {
                return new Date(breach.date) >= sevenDaysAgo;
            }).length;

            document.getElementById('totalBreaches').textContent = breaches.length;
            document.getElementById('moroccoBreaches').textContent = moroccoBreaches.length;
            document.getElementById('recentBreaches').textContent = recentBreaches;
            document.getElementById('lastUpdate').textContent = formatDate(new Date());
            document.getElementById('lastUpdated').textContent = `Last updated: ${formatDate(new Date())}`;
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('breachesList');
            container.innerHTML = `<div class="error">${message}</div>`;
        }



        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Main tab switching logic
        function switchMainTab(tab) {
            const mainTabs = ['breaches', 'tools'];
            mainTabs.forEach(t => {
                document.getElementById(t + 'Tab').classList.remove('active');
                document.querySelector('.main-tab-button[onclick*="' + t + '"]').classList.remove('active');
            });
            document.getElementById(tab + 'Tab').classList.add('active');
            document.querySelector('.main-tab-button[onclick*="' + tab + '"]').classList.add('active');
        }

        // Sub tab switching logic (within tools tab)
        function switchSubTab(tab) {
            const tabs = ['analytics', 'domain', 'all', 'password'];
            tabs.forEach(t => {
                document.getElementById(t + 'Tab').classList.remove('active');
                document.querySelector('.tab-button[onclick*="' + t + '"]').classList.remove('active');
            });
            document.getElementById(tab + 'Tab').classList.add('active');
            document.querySelector('.tab-button[onclick*="' + tab + '"]').classList.add('active');
        }

        // Domain breach search
        async function searchDomainBreaches() {
            const domain = document.getElementById('domainInput').value.trim();
            if (!domain) {
                showDomainError('Please enter a domain.');
                return;
            }
            
            document.getElementById('domainLoading').style.display = 'block';
            document.getElementById('domainResults').style.display = 'none';
            document.getElementById('domainError').style.display = 'none';
            
            try {
                const response = await fetch(`https://api.xposedornot.com/v1/breaches?domain=${encodeURIComponent(domain)}`);
                
                if (response.status === 429) {
                    const errorData = await response.json();
                    const retryAfter = errorData.detail?.retry_after || 60;
                    showDomainError(`Rate limit exceeded. Please try again in ${Math.ceil(retryAfter / 60)} minutes.`);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayDomainResults(domain, data);
            } catch (error) {
                console.error('Domain search error:', error);
                showDomainError('Failed to search domain breaches.');
            } finally {
                document.getElementById('domainLoading').style.display = 'none';
            }
        }

        function displayDomainResults(domain, data) {
            const resultsDiv = document.getElementById('domainResults');
            const titleDiv = document.getElementById('domainResultsTitle');
            const riskScoreDiv = document.getElementById('domainRiskScore');
            const detailsDiv = document.getElementById('domainBreachDetails');
            
            titleDiv.textContent = `Domain Breach Results for ${domain}`;
            
            let riskLevel = 'safe', riskText = 'Safe';
            
            if (data['Exposed Breaches'] && data['Exposed Breaches'].length > 0) {
                const total = data['Exposed Breaches'].length;
                if (total > 10) { 
                    riskLevel = 'high'; 
                    riskText = 'High Risk'; 
                } else if (total > 3) { 
                    riskLevel = 'medium'; 
                    riskText = 'Medium Risk'; 
                } else { 
                    riskLevel = 'low'; 
                    riskText = 'Low Risk'; 
                }
            }
            
            riskScoreDiv.textContent = riskText;
            riskScoreDiv.className = `risk-score ${riskLevel}`;
            
            if (data['Exposed Breaches'] && data['Exposed Breaches'].length > 0) {
                let html = `<p><strong>Found ${data['Exposed Breaches'].length} breach(es)</strong></p>`;
                
                data['Exposed Breaches'].forEach(breach => {
                    const breachDate = new Date(breach['Breached Date']).toLocaleDateString();
                    const dataTypes = breach['Exposed Data'] ? breach['Exposed Data'].split(';') : [];
                    
                    html += `
                        <div class="breach-item-email">
                            <h4>${breach['Breach ID'] || 'Unknown Breach'}</h4>
                            <div class="breach-meta">
                                <span>üìÖ ${breachDate}</span>
                                <span>üè¢ ${breach['Domain'] || 'Unknown Domain'}</span>
                                <span>üìä ${breach['Exposed Records']?.toLocaleString() || 'Unknown'} records</span>
                                <span>üîí ${breach['Password Risk'] || 'Unknown'} password risk</span>
                            </div>
                            <div class="breach-description">
                                ${breach['Exposure Description'] || 'No description available'}
                            </div>
                            ${dataTypes.length > 0 ? `
                                <div class="breach-data-types">
                                    ${dataTypes.map(type => `<span class="data-type">${type.trim()}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                detailsDiv.innerHTML = html;
            } else {
                detailsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #2e7d32;">
                        <h3>‚úÖ No breaches found!</h3>
                        <p>This domain appears to be safe from known data breaches.</p>
                    </div>
                `;
            }
            
            resultsDiv.style.display = 'block';
        }

        function showDomainError(msg) {
            const errorDiv = document.getElementById('domainError');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
        }

        // Comprehensive Email Security Check
        async function getBreachAnalytics() {
            const email = document.getElementById('analyticsEmailInput').value.trim();
            if (!email) {
                showAnalyticsError('Please enter an email address.');
                return;
            }
            if (!isValidEmail(email)) {
                showAnalyticsError('Please enter a valid email address.');
                return;
            }
            
            document.getElementById('analyticsLoading').style.display = 'block';
            document.getElementById('analyticsResults').style.display = 'none';
            document.getElementById('analyticsError').style.display = 'none';
            
            try {
                const response = await fetch(`https://api.xposedornot.com/v1/breach-analytics?email=${encodeURIComponent(email)}`);
                
                if (response.status === 429) {
                    const errorData = await response.json();
                    const retryAfter = errorData.detail?.retry_after || 60;
                    showAnalyticsError(`Rate limit exceeded. Please try again in ${Math.ceil(retryAfter / 60)} minutes.`);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayAnalyticsResults(email, data);
            } catch (error) {
                console.error('Email check error:', error);
                showAnalyticsError('Failed to check email security.');
            } finally {
                document.getElementById('analyticsLoading').style.display = 'none';
            }
        }

        function displayAnalyticsResults(email, data) {
            const resultsDiv = document.getElementById('analyticsResults');
            const titleDiv = document.getElementById('analyticsResultsTitle');
            const detailsDiv = document.getElementById('analyticsDetails');
            
            titleDiv.textContent = `Email Security Report for ${email}`;
            
            if (data.Error) {
                detailsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #2e7d32;">
                        <h3>‚úÖ Email is Secure!</h3>
                        <p>No breach data found for this email address. Your email appears to be safe from known data breaches.</p>
                    </div>
                `;
            } else if (data.BreachesSummary || data.BreachMetrics) {
                let html = '<div class="analytics-grid">';
                
                // Overall Security Status
                let totalBreaches = 0;
                let riskLevel = 'Safe';
                let riskColor = '#388e3c';
                
                if (data.ExposedBreaches && data.ExposedBreaches.breaches_details) {
                    totalBreaches = data.ExposedBreaches.breaches_details.length;
                    if (totalBreaches > 10) {
                        riskLevel = 'High Risk';
                        riskColor = '#d32f2f';
                    } else if (totalBreaches > 3) {
                        riskLevel = 'Medium Risk';
                        riskColor = '#f57c00';
                    } else if (totalBreaches > 0) {
                        riskLevel = 'Low Risk';
                        riskColor = '#f57c00';
                    }
                }
                
                // Security Status Card
                html += `
                    <div class="analytics-card">
                        <h4>üõ°Ô∏è Overall Security Status</h4>
                        <div class="analytics-stat">
                            <span class="stat-label">Status</span>
                            <span class="stat-value" style="color: ${riskColor}; font-weight: bold; font-size: 18px;">${riskLevel}</span>
                        </div>
                        <div class="analytics-stat">
                            <span class="stat-label">Total Breaches</span>
                            <span class="stat-value">${totalBreaches}</span>
                        </div>
                    </div>
                `;
                
                // Risk Assessment Card
                if (data.BreachMetrics && data.BreachMetrics.risk && data.BreachMetrics.risk.length > 0) {
                    const risk = data.BreachMetrics.risk[0];
                    const riskLabel = risk.risk_label || 'Unknown';
                    const riskScore = risk.risk_score || 0;
                    const riskColor = riskLabel.toLowerCase() === 'high' ? '#d32f2f' : 
                                    riskLabel.toLowerCase() === 'medium' ? '#f57c00' : '#388e3c';
                    
                    html += `
                        <div class="analytics-card">
                            <h4>üîí Risk Assessment</h4>
                            <div class="analytics-stat">
                                <span class="stat-label">Risk Level</span>
                                <span class="stat-value" style="color: ${riskColor}; font-weight: bold;">${riskLabel}</span>
                            </div>
                            <div class="analytics-stat">
                                <span class="stat-label">Risk Score</span>
                                <span class="stat-value">${riskScore}/10</span>
                            </div>
                        </div>
                    `;
                }
                
                // Password Security Card
                if (data.BreachMetrics && data.BreachMetrics.passwords_strength && data.BreachMetrics.passwords_strength.length > 0) {
                    const strength = data.BreachMetrics.passwords_strength[0];
                    html += `
                        <div class="analytics-card">
                            <h4>üîê Password Security</h4>
                            <div class="analytics-stat">
                                <span class="stat-label">Easy to Crack</span>
                                <span class="stat-value">${strength.EasyToCrack || 0}</span>
                            </div>
                            <div class="analytics-stat">
                                <span class="stat-label">Strong Hashes</span>
                                <span class="stat-value">${strength.StrongHash || 0}</span>
                            </div>
                            <div class="analytics-stat">
                                <span class="stat-label">Plain Text</span>
                                <span class="stat-value">${strength.PlainText || 0}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Breach Summary Card
                if (data.BreachesSummary && data.BreachesSummary.site) {
                    const sites = data.BreachesSummary.site.split(';').filter(site => site.trim());
                    html += `
                        <div class="analytics-card">
                            <h4>üìä Breach Summary</h4>
                            <div class="analytics-stat">
                                <span class="stat-label">Affected Sites</span>
                                <span class="stat-value">${sites.join(', ')}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Industry Analysis
                if (data.BreachMetrics && data.BreachMetrics.industry && data.BreachMetrics.industry.length > 0) {
                    const industries = data.BreachMetrics.industry[0];
                    const affectedIndustries = industries.filter(ind => ind[1] > 0);
                    
                    if (affectedIndustries.length > 0) {
                        const industryNames = {
                            'ente': 'Entertainment',
                            'info': 'Information Technology',
                            'fina': 'Finance',
                            'reta': 'Retail',
                            'educ': 'Education',
                            'gove': 'Government',
                            'heal': 'Healthcare',
                            'tele': 'Telecommunications',
                            'tran': 'Transportation',
                            'manu': 'Manufacturing',
                            'ener': 'Energy',
                            'cons': 'Construction',
                            'agri': 'Agriculture',
                            'hosp': 'Hospitality',
                            'news': 'News & Media',
                            'spor': 'Sports',
                            'envi': 'Environment',
                            'nonp': 'Non-Profit',
                            'aero': 'Aerospace',
                            'mini': 'Mining',
                            'musi': 'Music',
                            'misc': 'Miscellaneous',
                            'elec': 'Electronics',
                            'phar': 'Pharmaceuticals',
                            'food': 'Food & Beverage'
                        };
                        
                        html += `
                            <div class="analytics-card">
                                <h4>üè¢ Affected Industries</h4>
                                ${affectedIndustries.map(ind => `
                                    <div class="analytics-stat">
                                        <span class="stat-label">${industryNames[ind[0]] || ind[0]}</span>
                                        <span class="stat-value">${ind[1]} breach(es)</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                }
                
                // Detailed Breach Information
                if (data.ExposedBreaches && data.ExposedBreaches.breaches_details) {
                    html += `
                        <div class="analytics-card">
                            <h4>üìã Detailed Breach Information</h4>
                            ${data.ExposedBreaches.breaches_details.map(breach => `
                                <div class="breach-item-email">
                                    <h4>${breach.breach}</h4>
                                    <div class="breach-meta">
                                        <span>üìÖ ${breach.xposed_date || 'Unknown'}</span>
                                        <span>üè¢ ${breach.domain || 'Unknown'}</span>
                                        <span>üìä ${breach.xposed_records?.toLocaleString() || 'Unknown'} records</span>
                                        <span>üîí ${breach.password_risk || 'Unknown'} password risk</span>
                                    </div>
                                    <div class="breach-description">${breach.details || 'No description available'}</div>
                                    ${breach.xposed_data ? `
                                        <div class="breach-data-types">
                                            <strong>Exposed Data:</strong> ${breach.xposed_data}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Yearly Analysis
                if (data.BreachMetrics && data.BreachMetrics.yearwise_details && data.BreachMetrics.yearwise_details.length > 0) {
                    const yearlyData = data.BreachMetrics.yearwise_details[0];
                    const yearsWithBreaches = Object.entries(yearlyData).filter(([year, count]) => count > 0);
                    
                    if (yearsWithBreaches.length > 0) {
                        html += `
                            <div class="analytics-card">
                                <h4>üìà Breach Timeline</h4>
                                ${yearsWithBreaches.map(([year, count]) => `
                                    <div class="analytics-stat">
                                        <span class="stat-label">${year.replace('y', '')}</span>
                                        <span class="stat-value">${count} breach(es)</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                }
                
                // Security Recommendations
                html += `
                    <div class="analytics-card">
                        <h4>üí° Security Recommendations</h4>
                        <div class="security-recommendations">
                            ${totalBreaches > 0 ? `
                                <ul>
                                    <li>üîê Change passwords for all affected accounts immediately</li>
                                    <li>üîë Use unique, strong passwords for each account</li>
                                    <li>üîí Enable two-factor authentication where possible</li>
                                    <li>üìß Monitor your email for suspicious activity</li>
                                    <li>üõ°Ô∏è Consider using a password manager</li>
                                    <li>üì± Enable account recovery options</li>
                                </ul>
                            ` : `
                                <p>‚úÖ Your email appears to be secure. Continue to:</p>
                                <ul>
                                    <li>üîê Use strong, unique passwords</li>
                                    <li>üîí Enable two-factor authentication</li>
                                    <li>üõ°Ô∏è Monitor your accounts regularly</li>
                                </ul>
                            `}
                        </div>
                    </div>
                `;
                
                html += '</div>';
                detailsDiv.innerHTML = html;
            } else {
                detailsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #2e7d32;">
                        <h3>No breach data found!</h3>
                    </div>
                `;
            }
            
            resultsDiv.style.display = 'block';
        }

        function showAnalyticsError(msg) {
            const errorDiv = document.getElementById('analyticsError');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
        }

        // All breaches
        async function getAllBreaches() {
            document.getElementById('allBreachesLoading').style.display = 'block';
            document.getElementById('allBreachesResults').style.display = 'none';
            document.getElementById('allBreachesError').style.display = 'none';
            
            try {
                const response = await fetch('https://api.xposedornot.com/v1/breaches');
                
                if (response.status === 429) {
                    const errorData = await response.json();
                    const retryAfter = errorData.detail?.retry_after || 60;
                    showAllBreachesError(`Rate limit exceeded. Please try again in ${Math.ceil(retryAfter / 60)} minutes.`);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayAllBreaches(data);
            } catch (error) {
                console.error('All breaches error:', error);
                showAllBreachesError('Failed to fetch all breaches.');
            } finally {
                document.getElementById('allBreachesLoading').style.display = 'none';
            }
        }

        function displayAllBreaches(data) {
            const resultsDiv = document.getElementById('allBreachesResults');
            const titleDiv = document.getElementById('allBreachesTitle');
            const countDiv = document.getElementById('totalBreachCount');
            const detailsDiv = document.getElementById('allBreachesDetails');
            
            if (data.exposedBreaches && data.exposedBreaches.length > 0) {
                countDiv.textContent = `${data.exposedBreaches.length} breaches`;
                let html = '<div class="breach-list">';
                
                data.exposedBreaches.slice(0, 50).forEach(breach => {
                    const breachDate = new Date(breach.breachedDate).toLocaleDateString();
                    html += `
                        <div class="breach-list-item">
                            <h4>${breach.breachID}</h4>
                            <div class="breach-meta">
                                <span>üìÖ ${breachDate}</span>
                                <span>üè¢ ${breach.domain || 'Unknown'}</span>
                                <span>üìä ${breach.exposedRecords?.toLocaleString() || 'Unknown'} records</span>
                            </div>
                            <p>${breach.exposureDescription || 'No description available'}</p>
                        </div>
                    `;
                });
                
                if (data.exposedBreaches.length > 50) {
                    html += `<div style="text-align: center; padding: 10px; color: #666;">
                        Showing first 50 of ${data.exposedBreaches.length} breaches...
                    </div>`;
                }
                
                html += '</div>';
                detailsDiv.innerHTML = html;
            } else {
                detailsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #2e7d32;">
                        <h3>No breaches found!</h3>
                    </div>
                `;
            }
            
            resultsDiv.style.display = 'block';
        }

        function showAllBreachesError(msg) {
            const errorDiv = document.getElementById('allBreachesError');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
        }

        // Password checking functionality
        async function checkPassword() {
            const password = document.getElementById('passwordInput').value.trim();
            if (!password) {
                showPasswordError('Please enter a password.');
                return;
            }
            
            document.getElementById('passwordLoading').style.display = 'block';
            document.getElementById('passwordResults').style.display = 'none';
            document.getElementById('passwordError').style.display = 'none';
            
            try {
                // Generate SHA3-Keccak-512 hash using the js-sha3 library
                const hash = generateSHA3Keccak512(password);
                const first10Chars = hash.substring(0, 10);
                
                console.log('Checking password hash:', first10Chars);
                
                // Use the correct API endpoint as shown in the reference
                const response = await fetch(`https://passwords.xposedornot.com/api/v1/pass/anon/${encodeURIComponent(first10Chars)}`);
                
                if (response.status === 429) {
                    const errorData = await response.json();
                    const retryAfter = errorData.detail?.retry_after || 60;
                    showPasswordError(`Rate limit exceeded. Please try again in ${Math.ceil(retryAfter / 60)} minutes.`);
                    return;
                }
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Password not found in breaches
                        displayPasswordResults(password, { Error: "Not found" });
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayPasswordResults(password, data);
            } catch (error) {
                console.error('Password check error:', error);
                showPasswordError('Failed to check password. Please try again later.');
            } finally {
                document.getElementById('passwordLoading').style.display = 'none';
            }
        }

        function generateSHA3Keccak512(input) {
            // Check if keccak_512 function is available
            if (typeof keccak_512 === 'undefined') {
                console.error('SHA3 library not loaded');
                throw new Error('SHA3 library not available. Please check your internet connection.');
            }
            
            // Use the keccak_512 function from the js-sha3 library
            return keccak_512(input);
        }

        function displayPasswordResults(password, data) {
            const resultsDiv = document.getElementById('passwordResults');
            const titleDiv = document.getElementById('passwordResultsTitle');
            const riskScoreDiv = document.getElementById('passwordRiskScore');
            const detailsDiv = document.getElementById('passwordDetails');
            
            titleDiv.textContent = 'Password Security Check';
            
            if (data.Error) {
                // Password not found in breaches
                riskScoreDiv.textContent = 'Safe';
                riskScoreDiv.className = 'risk-score safe';
                detailsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #2e7d32;">
                        <h3>‚úÖ Password not found in breaches!</h3>
                        <p>This password appears to be safe from known data breaches.</p>
                    </div>
                `;
            } else if (data.SearchPassAnon) {
                const result = data.SearchPassAnon;
                const count = parseInt(result.count) || 0;
                
                let riskLevel = 'safe', riskText = 'Safe';
                if (count > 1000000) {
                    riskLevel = 'high';
                    riskText = 'High Risk';
                } else if (count > 10000) {
                    riskLevel = 'medium';
                    riskText = 'Medium Risk';
                } else if (count > 0) {
                    riskLevel = 'low';
                    riskText = 'Low Risk';
                }
                
                riskScoreDiv.textContent = riskText;
                riskScoreDiv.className = `risk-score ${riskLevel}`;
                
                // Parse character breakdown
                const charBreakdown = result.char || '';
                const charParts = charBreakdown.split(';');
                let charInfo = {};
                charParts.forEach(part => {
                    const [key, value] = part.split(':');
                    if (key && value) {
                        charInfo[key] = parseInt(value) || 0;
                    }
                });
                
                detailsDiv.innerHTML = `
                    <div class="password-result">
                        <h3>‚ö†Ô∏è Password found in breaches!</h3>
                        <div class="password-stats">
                            <div class="stat-item">
                                <span class="stat-label">Times exposed:</span>
                                <span class="stat-value">${count.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Password length:</span>
                                <span class="stat-value">${charInfo.L || 'Unknown'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Contains digits:</span>
                                <span class="stat-value">${charInfo.D || 0}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Contains letters:</span>
                                <span class="stat-value">${charInfo.A || 0}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Contains symbols:</span>
                                <span class="stat-value">${charInfo.S || 0}</span>
                            </div>
                        </div>
                        <div class="password-recommendation">
                            <h4>Recommendation:</h4>
                            <p>This password has been exposed in data breaches. We strongly recommend changing it immediately and using a unique, strong password for each account.</p>
                        </div>
                    </div>
                `;
            } else {
                riskScoreDiv.textContent = 'Unknown';
                riskScoreDiv.className = 'risk-score unknown';
                detailsDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <h3>Unable to check password</h3>
                        <p>Could not verify password security status.</p>
                    </div>
                `;
            }
            
            resultsDiv.style.display = 'block';
        }

        function showPasswordError(msg) {
            const errorDiv = document.getElementById('passwordError');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
        }

        // Search and filter functionality
        let allBreachesData = [];

        function setupSearchAndFilter() {
            const searchInput = document.getElementById('breachSearch');
            const filterSelect = document.getElementById('breachFilter');
            
            searchInput.addEventListener('input', filterBreaches);
            filterSelect.addEventListener('change', filterBreaches);
        }

        function filterBreaches() {
            const searchTerm = document.getElementById('breachSearch').value.toLowerCase();
            const filterType = document.getElementById('breachFilter').value;
            
            let filteredBreaches = allBreachesData;
            
            // Apply filter
            if (filterType === 'morocco') {
                filteredBreaches = filteredBreaches.filter(breach => {
                    const content = (breach.text || breach.content || '').toLowerCase();
                    return moroccoKeywords.some(keyword => content.includes(keyword.toLowerCase()));
                });
            } else if (filterType === 'recent') {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                filteredBreaches = filteredBreaches.filter(breach => {
                    return new Date(breach.date) >= sevenDaysAgo;
                });
            }
            
            // Apply search
            if (searchTerm) {
                filteredBreaches = filteredBreaches.filter(breach => {
                    const content = (breach.text || breach.content || '').toLowerCase();
                    return content.includes(searchTerm);
                });
            }
            
            displayBreaches(filteredBreaches);
        }

        // Auto-refresh every 5 minutes
        setInterval(loadBreachData, 5 * 60 * 1000);

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadBreachData();
            setupSearchAndFilter();
        });
    </script>
</body>
</html> 